// main program for node based word guessing game
import * as _ from "lodash";
import Word from "./word";
import { terminal as term } from "terminal-kit";
// global variables and constants
const wordsArr = [
    "javascript",
    "html",
    "mongo",
    "chrome",
    "node",
    "css"
];
// offsets the instructions from left hand side
const xOffset = 5;
// object to hold x,y locations of inputs and outputs for use by terminal-kit
const termXY = {
    chosenLetters: { x: 25, y: 12 },
    wordSoFar: { x: 25, y: 16 },
    getWord: { x: 25, y: 20 },
    input: { x: 25, y: 18 },
    chooseAgain: { x: 25, y: 23 },
    guesses: { x: 25, y: 11 },
    title: { x: 30, y: 2 },
    instructions: { x: 5, y: 4 }
};
// can't seem to turn off the event listener so using a global variable to make it doesn't return anything
var readWord = false;
// holds the word selected by random from wordsArr
var theWord;
// array to hold the letters chosen
var lettersChosen = [];
// number of guesses and max allowed
var guesses = -1; // referenced through incGuesses function which always increments so start at -1
const maxGuesses = 10;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// functions
// randomly choose a word from wordsArr
function chooseWord() {
    let random = _.random(0, (wordsArr.length - 1));
    theWord = new Word(wordsArr[random]);
}
// clears the screen and then prints out all the information
function setupTerminal() {
    term.clear();
    // write information to screen
    // title
    term.moveTo(termXY.title.x, termXY.title.y);
    term.bold("Word game");
    // instructions
    term.moveTo(termXY.instructions.x, termXY.instructions.y);
    term("Instructions:\n");
    term("         Press keys to guess letters, you have " + maxGuesses + " attempts\n");
    term("         press RETURN to guess at the word (takes up 1 attempt)\n");
    term("         press control-C to end the game at any time");
    term.moveTo(xOffset, termXY.input.y);
    term("Type letters");
    term.moveTo(xOffset, termXY.chosenLetters.y);
    term("Letters chosen ");
    term.moveTo(xOffset, termXY.wordSoFar.y);
    term("Word so far ");
    // move cursor to input position
    term.moveTo(termXY.input.x, termXY.input.y);
}
function showWord() {
    let word = theWord.word2string();
    term.moveTo(termXY.wordSoFar.x, termXY.wordSoFar.y);
    term(word);
    // want to know how many characters
    term("  (" + theWord.letterArr.length + " characters)");
    term.moveTo(termXY.input.x, termXY.input.y);
}
function showLettersChosen() {
    term.moveTo(termXY.chosenLetters.x, termXY.chosenLetters.y);
    term(lettersChosen.join(","));
    term.moveTo(termXY.input.x, termXY.input.y);
}
function exitGame(message) {
    // move down 10 lines
    term.nextLine(10);
    if (message !== undefined) {
        console.log(String(message));
    }
    // using this exit resets any strange stuff the terminal is doing
    term.processExit(0);
}
function incGuess() {
    guesses += 1;
    if (guesses > maxGuesses) {
        // too many guesses
        term.moveTo(termXY.chooseAgain.x, termXY.chooseAgain.y);
        term("Too many guesses, you lose. ");
        term(" Another game ? (Y/n)");
        readWord = true; // not really reading word but disables key event
        term.yesOrNo({ yes: ['y', 'Y', 'ENTER'], no: ['n', 'N'] }, function (error, result) {
            if (result) {
                readWord = false; // re-enabled key event
                start();
            }
            else {
                exitGame();
            }
        });
    }
    else {
        term.moveTo(termXY.guesses.x, termXY.guesses.y);
        term(guesses + "/" + maxGuesses + " guesses");
        // move cursor back to input position
        term.moveTo(termXY.input.x, termXY.input.y);
    }
}
function guessWord() {
    term.moveTo(xOffset, termXY.getWord.y);
    term("Guess the word ");
    term.moveTo(xOffset, termXY.getWord.y + 1);
    term("(RETURN to finish)");
    // move cursor to word input position
    term.moveTo(termXY.getWord.x, termXY.getWord.y);
    // erase what was there
    term("                                     ");
    term.moveTo(termXY.getWord.x, termXY.getWord.y);
    term("Here " + termXY.getWord.x + "," + termXY.getWord.y);
    term.moveTo(termXY.getWord.x, termXY.getWord.y + 5);
    // turn off the key event listener using global variable
    readWord = true;
    term.inputField({}, function (error, input) {
        if (error) {
            exitGame(term.red.str("\nAn error occurred reading input field: " + error + "\n"));
        }
        else {
            if (input === theWord.word2FullString()) {
                // guessed right
                readWord = false;
                wordCompleted();
            }
            else {
                // erase the instructions
                term.moveTo(xOffset, termXY.getWord.y);
                term("                                   ");
                term.moveTo(xOffset, termXY.getWord.y + 1);
                term("                    ");
                // let user know what happened
                term.moveTo(termXY.getWord.x, termXY.getWord.y);
                term("Guess \"" + input + "\" was wrong                                  ");
                // move cursor back to input position
                term.moveTo(termXY.input.x, termXY.input.y);
            }
        }
        // let the event listener work again
        readWord = false;
    });
}
// function called when a key is pressed in raw mode
function processInput(char) {
    const regexp = new RegExp("[a-z]", "i");
    if (char === "ENTER") {
        // make a guess at the word
        guessWord();
        incGuess();
    }
    else if ((char.length === 1) && (regexp.test(char))) {
        const lcChar = char.toLowerCase();
        // check to see whether letter has already been selected
        if (_.indexOf(lettersChosen, lcChar) > -1) {
            // don't process anything because letter has already been selected
        }
        else {
            incGuess();
            theWord.checkChar(lcChar);
            lettersChosen.push(lcChar);
            // check to see if word is completed
            if (theWord.word2string().includes("_")) {
                // not completed
                showWord();
                showLettersChosen();
            }
            else {
                showWord();
                showLettersChosen();
                wordCompleted();
            }
        }
    }
    // any other key pressed does nothing  
}
function wordCompleted() {
    // erase guessed word
    term.moveTo(termXY.getWord.x, termXY.getWord.y);
    term("                                          ");
    term.moveTo(termXY.chooseAgain.x, termXY.chooseAgain.y);
    term("completed word \"" + theWord.word2FullString() + "\"");
    term(" Another game ? (Y/n)");
    readWord = true; // not really reading word but disables key event
    term.yesOrNo({ yes: ['y', 'Y', 'ENTER'], no: ['n', 'N'] }, function (error, result) {
        if (result) {
            readWord = false; // re-enabled key event
            start();
        }
        else {
            exitGame();
        }
    });
}
function start() {
    chooseWord();
    lettersChosen = [];
    guesses = -1; // referenced through incGuesses function which always increments so start at -1
    setupTerminal();
    showWord();
    showLettersChosen();
    incGuess(); // increments to 0 and displays number of guesses
    // after setup, program is driven by key presses
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// main program
start();
// set terminal up to read key presses
term.grabInput(true);
// set watcher on key input
term.on('key', function (name, matches, data) {
    if (name === 'CTRL_C') {
        exitGame("Control C pressed - exiting game");
    }
    else {
        // console.log("'key' event:" + name + " matches " + matches + " data " + data);
        if (!readWord) {
            processInput(name);
        }
    }
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LGVBQWU7QUFDZixLQUFLLEVBQUUsQ0FBQztBQUVSLHNDQUFzQztBQUN0QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRXJCLDJCQUEyQjtBQUMzQixJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxVQUFVLElBQVcsRUFBRSxPQUFXLEVBQUUsSUFBUTtJQUN2RCxJQUFJLElBQUksS0FBSyxRQUFRLEVBQUU7UUFDbkIsUUFBUSxDQUFDLGtDQUFrQyxDQUFDLENBQUM7S0FDaEQ7U0FDSTtRQUNELGdGQUFnRjtRQUVoRixJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ1gsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3RCO0tBQ0o7QUFDTCxDQUFDLENBQUMsQ0FBQyIsImZpbGUiOiJ3b3JkR2FtZU5vZGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBtYWluIHByb2dyYW0gZm9yIG5vZGUgYmFzZWQgd29yZCBndWVzc2luZyBnYW1lXHJcblxyXG5pbXBvcnQgKiBhcyBfIGZyb20gXCJsb2Rhc2hcIjtcclxuaW1wb3J0IFdvcmQgZnJvbSBcIi4vd29yZFwiO1xyXG5pbXBvcnQge3Rlcm1pbmFsIGFzIHRlcm19IGZyb20gXCJ0ZXJtaW5hbC1raXRcIjtcclxuXHJcblxyXG4vLyBnbG9iYWwgdmFyaWFibGVzIGFuZCBjb25zdGFudHNcclxuY29uc3Qgd29yZHNBcnIgPSBbXHJcbiAgICBcImphdmFzY3JpcHRcIixcclxuICAgIFwiaHRtbFwiLFxyXG4gICAgXCJtb25nb1wiLFxyXG4gICAgXCJjaHJvbWVcIixcclxuICAgIFwibm9kZVwiLFxyXG4gICAgXCJjc3NcIlxyXG5dO1xyXG5cclxuLy8gb2Zmc2V0cyB0aGUgaW5zdHJ1Y3Rpb25zIGZyb20gbGVmdCBoYW5kIHNpZGVcclxuY29uc3QgeE9mZnNldCA9IDU7XHJcbi8vIG9iamVjdCB0byBob2xkIHgseSBsb2NhdGlvbnMgb2YgaW5wdXRzIGFuZCBvdXRwdXRzIGZvciB1c2UgYnkgdGVybWluYWwta2l0XHJcbmNvbnN0IHRlcm1YWSA9IHtcclxuICAgIGNob3NlbkxldHRlcnM6IHsgeDoyNSwgeToxMn0sXHJcbiAgICB3b3JkU29GYXI6ICAgICB7IHg6MjUsIHk6MTZ9LFxyXG4gICAgZ2V0V29yZDogICAgICAgeyB4OjI1LCB5OjIwfSxcclxuICAgIGlucHV0OiAgICAgICAgIHsgeDoyNSwgeToxOH0sXHJcbiAgICBjaG9vc2VBZ2FpbjogICB7IHg6MjUsIHk6MjN9LFxyXG4gICAgZ3Vlc3NlczogICAgICAgeyB4OjI1LCB5OjExfSxcclxuICAgIHRpdGxlOiAgICAgICAgIHsgeDozMCwgeToyfSxcclxuICAgIGluc3RydWN0aW9uczogIHsgeDo1LCAgeTo0fVxyXG59O1xyXG5cclxuXHJcbi8vIGNhbid0IHNlZW0gdG8gdHVybiBvZmYgdGhlIGV2ZW50IGxpc3RlbmVyIHNvIHVzaW5nIGEgZ2xvYmFsIHZhcmlhYmxlIHRvIG1ha2UgaXQgZG9lc24ndCByZXR1cm4gYW55dGhpbmdcclxudmFyIHJlYWRXb3JkID0gZmFsc2U7XHJcbi8vIGhvbGRzIHRoZSB3b3JkIHNlbGVjdGVkIGJ5IHJhbmRvbSBmcm9tIHdvcmRzQXJyXHJcbnZhciB0aGVXb3JkOldvcmQ7XHJcblxyXG4vLyBhcnJheSB0byBob2xkIHRoZSBsZXR0ZXJzIGNob3NlblxyXG52YXIgbGV0dGVyc0Nob3NlbjpzdHJpbmdbXSA9IFtdO1xyXG5cclxuLy8gbnVtYmVyIG9mIGd1ZXNzZXMgYW5kIG1heCBhbGxvd2VkXHJcbnZhciBndWVzc2VzOm51bWJlciA9IC0xOyAvLyByZWZlcmVuY2VkIHRocm91Z2ggaW5jR3Vlc3NlcyBmdW5jdGlvbiB3aGljaCBhbHdheXMgaW5jcmVtZW50cyBzbyBzdGFydCBhdCAtMVxyXG5jb25zdCBtYXhHdWVzc2VzOm51bWJlciA9IDEwO1xyXG5cclxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cclxuLy8gZnVuY3Rpb25zXHJcblxyXG4vLyByYW5kb21seSBjaG9vc2UgYSB3b3JkIGZyb20gd29yZHNBcnJcclxuZnVuY3Rpb24gY2hvb3NlV29yZCAoKSB7XHJcbiAgICBsZXQgcmFuZG9tID0gXy5yYW5kb20oMCwgKHdvcmRzQXJyLmxlbmd0aCAtMSApKTtcclxuICAgIHRoZVdvcmQgPSBuZXcgV29yZCh3b3Jkc0FycltyYW5kb21dKTtcclxuICAgIFxyXG59XHJcblxyXG4vLyBjbGVhcnMgdGhlIHNjcmVlbiBhbmQgdGhlbiBwcmludHMgb3V0IGFsbCB0aGUgaW5mb3JtYXRpb25cclxuZnVuY3Rpb24gc2V0dXBUZXJtaW5hbCgpOnZvaWQge1xyXG4gICAgdGVybS5jbGVhcigpO1xyXG4gICAgLy8gd3JpdGUgaW5mb3JtYXRpb24gdG8gc2NyZWVuXHJcbiAgICAvLyB0aXRsZVxyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLnRpdGxlLngsIHRlcm1YWS50aXRsZS55KTtcclxuICAgIHRlcm0uYm9sZChcIldvcmQgZ2FtZVwiKTtcclxuICAgIC8vIGluc3RydWN0aW9uc1xyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLmluc3RydWN0aW9ucy54LCB0ZXJtWFkuaW5zdHJ1Y3Rpb25zLnkpO1xyXG4gICAgdGVybShcIkluc3RydWN0aW9uczpcXG5cIik7XHJcbiAgICB0ZXJtKFwiICAgICAgICAgUHJlc3Mga2V5cyB0byBndWVzcyBsZXR0ZXJzLCB5b3UgaGF2ZSBcIiArIG1heEd1ZXNzZXMgKyBcIiBhdHRlbXB0c1xcblwiKTtcclxuICAgIHRlcm0oXCIgICAgICAgICBwcmVzcyBSRVRVUk4gdG8gZ3Vlc3MgYXQgdGhlIHdvcmQgKHRha2VzIHVwIDEgYXR0ZW1wdClcXG5cIik7XHJcbiAgICB0ZXJtKFwiICAgICAgICAgcHJlc3MgY29udHJvbC1DIHRvIGVuZCB0aGUgZ2FtZSBhdCBhbnkgdGltZVwiKTtcclxuICAgIHRlcm0ubW92ZVRvKHhPZmZzZXQsdGVybVhZLmlucHV0LnkpO1xyXG4gICAgdGVybShcIlR5cGUgbGV0dGVyc1wiKTtcclxuICAgIHRlcm0ubW92ZVRvKHhPZmZzZXQsIHRlcm1YWS5jaG9zZW5MZXR0ZXJzLnkpO1xyXG4gICAgdGVybShcIkxldHRlcnMgY2hvc2VuIFwiKTtcclxuICAgIHRlcm0ubW92ZVRvKHhPZmZzZXQsIHRlcm1YWS53b3JkU29GYXIueSk7XHJcbiAgICB0ZXJtKFwiV29yZCBzbyBmYXIgXCIpO1xyXG4gICAgLy8gbW92ZSBjdXJzb3IgdG8gaW5wdXQgcG9zaXRpb25cclxuICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5pbnB1dC54LCB0ZXJtWFkuaW5wdXQueSk7XHJcblxyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gc2hvd1dvcmQoKTp2b2lkIHtcclxuICAgIGxldCB3b3JkOnN0cmluZyA9IHRoZVdvcmQud29yZDJzdHJpbmcoKTtcclxuICAgIHRlcm0ubW92ZVRvKHRlcm1YWS53b3JkU29GYXIueCwgdGVybVhZLndvcmRTb0Zhci55KTtcclxuICAgIHRlcm0od29yZCk7XHJcbiAgICAvLyB3YW50IHRvIGtub3cgaG93IG1hbnkgY2hhcmFjdGVyc1xyXG4gICAgdGVybShcIiAgKFwiICsgdGhlV29yZC5sZXR0ZXJBcnIubGVuZ3RoICsgXCIgY2hhcmFjdGVycylcIik7XHJcbiAgICB0ZXJtLm1vdmVUbyh0ZXJtWFkuaW5wdXQueCwgdGVybVhZLmlucHV0LnkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzaG93TGV0dGVyc0Nob3NlbiAoKTp2b2lkIHtcclxuICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5jaG9zZW5MZXR0ZXJzLngsIHRlcm1YWS5jaG9zZW5MZXR0ZXJzLnkpO1xyXG4gICAgdGVybSggbGV0dGVyc0Nob3Nlbi5qb2luKFwiLFwiKSk7XHJcbiAgICB0ZXJtLm1vdmVUbyh0ZXJtWFkuaW5wdXQueCwgdGVybVhZLmlucHV0LnkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBleGl0R2FtZShtZXNzYWdlPzogYW55KTogdm9pZCB7XHJcbiAgICAvLyBtb3ZlIGRvd24gMTAgbGluZXNcclxuICAgIHRlcm0ubmV4dExpbmUoMTApO1xyXG4gICAgaWYgKG1lc3NhZ2UgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFN0cmluZyhtZXNzYWdlKSk7XHJcbiAgICB9XHJcbiAgICAvLyB1c2luZyB0aGlzIGV4aXQgcmVzZXRzIGFueSBzdHJhbmdlIHN0dWZmIHRoZSB0ZXJtaW5hbCBpcyBkb2luZ1xyXG4gICAgdGVybS5wcm9jZXNzRXhpdCgwKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaW5jR3Vlc3MoKTp2b2lkIHtcclxuICAgIGd1ZXNzZXMgKz0gMTtcclxuICAgIGlmIChndWVzc2VzID4gbWF4R3Vlc3Nlcykge1xyXG4gICAgICAgIC8vIHRvbyBtYW55IGd1ZXNzZXNcclxuICAgICAgICB0ZXJtLm1vdmVUbyh0ZXJtWFkuY2hvb3NlQWdhaW4ueCwgdGVybVhZLmNob29zZUFnYWluLnkpO1xyXG4gICAgICAgIHRlcm0oXCJUb28gbWFueSBndWVzc2VzLCB5b3UgbG9zZS4gXCIpO1xyXG4gICAgICAgIHRlcm0oXCIgQW5vdGhlciBnYW1lID8gKFkvbilcIik7XHJcbiAgICAgICAgcmVhZFdvcmQgPSB0cnVlOyAvLyBub3QgcmVhbGx5IHJlYWRpbmcgd29yZCBidXQgZGlzYWJsZXMga2V5IGV2ZW50XHJcbiAgICAgICAgdGVybS55ZXNPck5vKHsgeWVzOiBbJ3knLCAnWScsICdFTlRFUiddLCBubzogWyduJywgJ04nXSB9LCBmdW5jdGlvbiAoZXJyb3IsIHJlc3VsdCkge1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICByZWFkV29yZCA9IGZhbHNlOyAvLyByZS1lbmFibGVkIGtleSBldmVudFxyXG4gICAgICAgICAgICAgICAgc3RhcnQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGV4aXRHYW1lKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5ndWVzc2VzLngsIHRlcm1YWS5ndWVzc2VzLnkpO1xyXG4gICAgICAgIHRlcm0oZ3Vlc3NlcyArIFwiL1wiICsgbWF4R3Vlc3NlcyArIFwiIGd1ZXNzZXNcIik7XHJcbiAgICAgICAgLy8gbW92ZSBjdXJzb3IgYmFjayB0byBpbnB1dCBwb3NpdGlvblxyXG4gICAgICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5pbnB1dC54LCB0ZXJtWFkuaW5wdXQueSk7XHJcbiAgICAgICAgXHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGd1ZXNzV29yZCgpOnZvaWQge1xyXG4gICAgdGVybS5tb3ZlVG8oeE9mZnNldCwgdGVybVhZLmdldFdvcmQueSk7XHJcbiAgICB0ZXJtKFwiR3Vlc3MgdGhlIHdvcmQgXCIpO1xyXG4gICAgdGVybS5tb3ZlVG8oeE9mZnNldCwgdGVybVhZLmdldFdvcmQueSArIDEpO1xyXG4gICAgdGVybShcIihSRVRVUk4gdG8gZmluaXNoKVwiKTtcclxuICAgIC8vIG1vdmUgY3Vyc29yIHRvIHdvcmQgaW5wdXQgcG9zaXRpb25cclxuICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5nZXRXb3JkLngsIHRlcm1YWS5nZXRXb3JkLnkpO1xyXG4gICAgLy8gZXJhc2Ugd2hhdCB3YXMgdGhlcmVcclxuICAgIHRlcm0oXCIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCIpO1xyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLmdldFdvcmQueCwgdGVybVhZLmdldFdvcmQueSk7XHJcbiAgICB0ZXJtKFwiSGVyZSBcIiArIHRlcm1YWS5nZXRXb3JkLnggKyBcIixcIiArIHRlcm1YWS5nZXRXb3JkLnkpO1xyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLmdldFdvcmQueCwgdGVybVhZLmdldFdvcmQueSArIDUpO1xyXG4gICAgLy8gdHVybiBvZmYgdGhlIGtleSBldmVudCBsaXN0ZW5lciB1c2luZyBnbG9iYWwgdmFyaWFibGVcclxuICAgIHJlYWRXb3JkID0gdHJ1ZTtcclxuICAgIHRlcm0uaW5wdXRGaWVsZCh7fSxmdW5jdGlvbiAoZXJyb3I6IGFueSwgaW5wdXQ6IHN0cmluZykge1xyXG4gICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICBleGl0R2FtZSh0ZXJtLnJlZC5zdHIoXCJcXG5BbiBlcnJvciBvY2N1cnJlZCByZWFkaW5nIGlucHV0IGZpZWxkOiBcIiArIGVycm9yICsgXCJcXG5cIikpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgaWYoIGlucHV0ID09PSB0aGVXb3JkLndvcmQyRnVsbFN0cmluZygpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBndWVzc2VkIHJpZ2h0XHJcbiAgICAgICAgICAgICAgICByZWFkV29yZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgd29yZENvbXBsZXRlZCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gZXJhc2UgdGhlIGluc3RydWN0aW9uc1xyXG4gICAgICAgICAgICAgICAgdGVybS5tb3ZlVG8oeE9mZnNldCwgdGVybVhZLmdldFdvcmQueSk7XHJcbiAgICAgICAgICAgICAgICB0ZXJtKFwiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIik7XHJcbiAgICAgICAgICAgICAgICB0ZXJtLm1vdmVUbyh4T2Zmc2V0LCB0ZXJtWFkuZ2V0V29yZC55ICsgMSk7XHJcbiAgICAgICAgICAgICAgICB0ZXJtKFwiICAgICAgICAgICAgICAgICAgICBcIik7XHJcbiAgICAgICAgICAgICAgICAvLyBsZXQgdXNlciBrbm93IHdoYXQgaGFwcGVuZWRcclxuICAgICAgICAgICAgICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5nZXRXb3JkLngsIHRlcm1YWS5nZXRXb3JkLnkpO1xyXG4gICAgICAgICAgICAgICAgdGVybShcIkd1ZXNzIFxcXCJcIiArIGlucHV0ICsgXCJcXFwiIHdhcyB3cm9uZyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIik7XHJcbiAgICAgICAgICAgICAgICAvLyBtb3ZlIGN1cnNvciBiYWNrIHRvIGlucHV0IHBvc2l0aW9uXHJcbiAgICAgICAgICAgICAgICB0ZXJtLm1vdmVUbyh0ZXJtWFkuaW5wdXQueCwgdGVybVhZLmlucHV0LnkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGxldCB0aGUgZXZlbnQgbGlzdGVuZXIgd29yayBhZ2FpblxyXG4gICAgICAgIHJlYWRXb3JkID0gZmFsc2U7XHJcbiAgICB9KTtcclxufVxyXG4vLyBmdW5jdGlvbiBjYWxsZWQgd2hlbiBhIGtleSBpcyBwcmVzc2VkIGluIHJhdyBtb2RlXHJcbmZ1bmN0aW9uIHByb2Nlc3NJbnB1dCggY2hhcjpzdHJpbmcpOnZvaWQge1xyXG4gICAgY29uc3QgcmVnZXhwID0gbmV3IFJlZ0V4cChcIlthLXpdXCIsIFwiaVwiKTtcclxuICAgIGlmICggY2hhciA9PT0gXCJFTlRFUlwiKSB7XHJcbiAgICAgICAgLy8gbWFrZSBhIGd1ZXNzIGF0IHRoZSB3b3JkXHJcbiAgICAgICAgZ3Vlc3NXb3JkKCk7XHJcbiAgICAgICAgaW5jR3Vlc3MoKTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKCAoY2hhci5sZW5ndGggPT09IDEpICYmIChyZWdleHAudGVzdChjaGFyKSkpIHtcclxuICAgICAgICBjb25zdCBsY0NoYXIgPSBjaGFyLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgLy8gY2hlY2sgdG8gc2VlIHdoZXRoZXIgbGV0dGVyIGhhcyBhbHJlYWR5IGJlZW4gc2VsZWN0ZWRcclxuICAgICAgICBpZiAoXy5pbmRleE9mKGxldHRlcnNDaG9zZW4sbGNDaGFyKSA+IC0xKSB7XHJcbiAgICAgICAgICAgIC8vIGRvbid0IHByb2Nlc3MgYW55dGhpbmcgYmVjYXVzZSBsZXR0ZXIgaGFzIGFscmVhZHkgYmVlbiBzZWxlY3RlZFxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgaW5jR3Vlc3MoKTtcclxuICAgICAgICAgICAgdGhlV29yZC5jaGVja0NoYXIobGNDaGFyKTtcclxuICAgICAgICAgICAgbGV0dGVyc0Nob3Nlbi5wdXNoKGxjQ2hhcik7XHJcbiAgICAgICAgICAgIC8vIGNoZWNrIHRvIHNlZSBpZiB3b3JkIGlzIGNvbXBsZXRlZFxyXG4gICAgICAgICAgICBpZiAodGhlV29yZC53b3JkMnN0cmluZygpLmluY2x1ZGVzKFwiX1wiKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gbm90IGNvbXBsZXRlZFxyXG4gICAgICAgICAgICAgICAgc2hvd1dvcmQoKTtcclxuICAgICAgICAgICAgICAgIHNob3dMZXR0ZXJzQ2hvc2VuKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzaG93V29yZCgpO1xyXG4gICAgICAgICAgICAgICAgc2hvd0xldHRlcnNDaG9zZW4oKTtcclxuICAgICAgICAgICAgICAgIHdvcmRDb21wbGV0ZWQoKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIGFueSBvdGhlciBrZXkgcHJlc3NlZCBkb2VzIG5vdGhpbmcgIFxyXG59XHJcblxyXG5mdW5jdGlvbiB3b3JkQ29tcGxldGVkKCk6dm9pZCB7XHJcbiAgICAvLyBlcmFzZSBndWVzc2VkIHdvcmRcclxuICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5nZXRXb3JkLngsIHRlcm1YWS5nZXRXb3JkLnkpO1xyXG4gICAgdGVybShcIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiKTtcclxuICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5jaG9vc2VBZ2Fpbi54LCB0ZXJtWFkuY2hvb3NlQWdhaW4ueSk7XHJcbiAgICB0ZXJtKFwiY29tcGxldGVkIHdvcmQgXFxcIlwiKyB0aGVXb3JkLndvcmQyRnVsbFN0cmluZygpICsgXCJcXFwiXCIpO1xyXG4gICAgdGVybShcIiBBbm90aGVyIGdhbWUgPyAoWS9uKVwiKTtcclxuICAgIHJlYWRXb3JkID0gdHJ1ZTsgLy8gbm90IHJlYWxseSByZWFkaW5nIHdvcmQgYnV0IGRpc2FibGVzIGtleSBldmVudFxyXG4gICAgdGVybS55ZXNPck5vKHsgeWVzOiBbJ3knLCAnWScsJ0VOVEVSJ10sIG5vOiBbJ24nLCAnTiddIH0sIGZ1bmN0aW9uIChlcnJvciwgcmVzdWx0KSB7XHJcbiAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgICByZWFkV29yZCA9IGZhbHNlOyAvLyByZS1lbmFibGVkIGtleSBldmVudFxyXG4gICAgICAgICAgICBzdGFydCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgZXhpdEdhbWUoKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIFxyXG59XHJcblxyXG5mdW5jdGlvbiBzdGFydCgpOnZvaWQgeyAgXHJcbiAgICBjaG9vc2VXb3JkKCk7XHJcbiAgICBsZXR0ZXJzQ2hvc2VuID0gW107XHJcbiAgICBndWVzc2VzID0gLTE7IC8vIHJlZmVyZW5jZWQgdGhyb3VnaCBpbmNHdWVzc2VzIGZ1bmN0aW9uIHdoaWNoIGFsd2F5cyBpbmNyZW1lbnRzIHNvIHN0YXJ0IGF0IC0xXHJcbiAgICBzZXR1cFRlcm1pbmFsKCk7XHJcbiAgICBzaG93V29yZCgpO1xyXG4gICAgc2hvd0xldHRlcnNDaG9zZW4oKTtcclxuICAgIGluY0d1ZXNzKCk7IC8vIGluY3JlbWVudHMgdG8gMCBhbmQgZGlzcGxheXMgbnVtYmVyIG9mIGd1ZXNzZXNcclxuXHJcbiAgICAvLyBhZnRlciBzZXR1cCwgcHJvZ3JhbSBpcyBkcml2ZW4gYnkga2V5IHByZXNzZXNcclxufVxyXG5cclxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cclxuLy8gbWFpbiBwcm9ncmFtXHJcbnN0YXJ0KCk7XHJcblxyXG4vLyBzZXQgdGVybWluYWwgdXAgdG8gcmVhZCBrZXkgcHJlc3Nlc1xyXG50ZXJtLmdyYWJJbnB1dCh0cnVlKTtcclxuXHJcbi8vIHNldCB3YXRjaGVyIG9uIGtleSBpbnB1dFxyXG50ZXJtLm9uKCdrZXknLCBmdW5jdGlvbiAobmFtZTpzdHJpbmcsIG1hdGNoZXM6YW55LCBkYXRhOmFueSkge1xyXG4gICAgaWYgKG5hbWUgPT09ICdDVFJMX0MnKSB7XHJcbiAgICAgICAgZXhpdEdhbWUoXCJDb250cm9sIEMgcHJlc3NlZCAtIGV4aXRpbmcgZ2FtZVwiKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiJ2tleScgZXZlbnQ6XCIgKyBuYW1lICsgXCIgbWF0Y2hlcyBcIiArIG1hdGNoZXMgKyBcIiBkYXRhIFwiICsgZGF0YSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKCFyZWFkV29yZCkge1xyXG4gICAgICAgICAgICBwcm9jZXNzSW5wdXQobmFtZSk7XHJcbiAgICAgICAgfSBcclxuICAgIH1cclxufSk7XHJcblxyXG5cclxuXHJcbiJdfQ==
