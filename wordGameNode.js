// main program for node based word guessing game
import * as _ from "lodash";
import Word from "./word";
import { terminal as term } from "terminal-kit";
// global variables and constants
const wordsArr = [
    "javascript",
    "html",
    "mongo",
    "chrome",
    "node",
    "css"
];
// offsets the instructions from left hand side
const xOffset = 5;
// object to hold x,y locations of inputs and outputs for use by terminal-kit
const termXY = {
    chosenLetters: { x: 25, y: 12 },
    wordSoFar: { x: 25, y: 16 },
    getWord: { x: 25, y: 20 },
    input: { x: 25, y: 18 },
    chooseAgain: { x: 25, y: 23 },
    guesses: { x: 25, y: 11 },
    title: { x: 30, y: 2 },
    instructions: { x: 5, y: 4 }
};
// can't seem to turn off the event listener so using a global variable to make it doesn't return anything
var readWord = false;
// holds the word selected by random from wordsArr
var theWord;
// array to hold the letters chosen
var lettersChosen = [];
// number of guesses and max allowed
var guesses = -1; // referenced through incGuesses function which always increments so start at -1
const maxGuesses = 10;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// functions
// randomly choose a word from wordsArr
function chooseWord() {
    let random = _.random(0, (wordsArr.length - 1));
    theWord = new Word(wordsArr[random]);
}
// clears the screen and then prints out instructions and information
function setupTerminal() {
    term.clear();
    // write information to screen
    // title
    term.moveTo(termXY.title.x, termXY.title.y);
    term.bold("Word Game");
    // instructions
    term.moveTo(termXY.instructions.x, termXY.instructions.y);
    term("Instructions:\n");
    term("         Press keys to guess letters, you have " + maxGuesses + " attempts\n");
    term("         press RETURN to guess at the word (takes up 1 attempt)\n");
    term("         press control-C to end the game at any time");
    term.moveTo(xOffset, termXY.input.y);
    term("Type letters");
    term.moveTo(xOffset, termXY.chosenLetters.y);
    term("Letters chosen ");
    term.moveTo(xOffset, termXY.wordSoFar.y);
    term("Word so far ");
    // move cursor to input position
    term.moveTo(termXY.input.x, termXY.input.y);
}
function showWord() {
    let word = theWord.word2string();
    term.moveTo(termXY.wordSoFar.x, termXY.wordSoFar.y);
    term(word);
    // want to know how many characters
    term("  (" + theWord.letterArr.length + " characters)");
    term.moveTo(termXY.input.x, termXY.input.y);
}
function showLettersChosen() {
    term.moveTo(termXY.chosenLetters.x, termXY.chosenLetters.y);
    term(lettersChosen.join(","));
    term.moveTo(termXY.input.x, termXY.input.y);
}
function exitGame(message) {
    // move down 10 lines
    term.nextLine(10);
    if (message !== undefined) {
        console.log(String(message));
    }
    // using this exit resets any strange stuff the terminal is doing
    term.processExit(0);
}
function incGuess() {
    guesses += 1;
    if (guesses > maxGuesses) {
        // too many guesses
        term.moveTo(termXY.chooseAgain.x, termXY.chooseAgain.y);
        term("Too many guesses, you lose. ");
        term(" Another game ? (Y/n)");
        readWord = true; // not really reading word but disables key event
        term.yesOrNo({ yes: ['y', 'Y', 'ENTER'], no: ['n', 'N'] }, function (error, result) {
            if (result) {
                readWord = false; // re-enabled key event
                start();
            }
            else {
                exitGame();
            }
        });
    }
    else {
        term.moveTo(termXY.guesses.x, termXY.guesses.y);
        term(guesses + "/" + maxGuesses + " guesses");
        // move cursor back to input position
        term.moveTo(termXY.input.x, termXY.input.y);
    }
}
// function to allow user to make a guess at the whole word
// this still has a BUG
function guessWord() {
    term.moveTo(xOffset, termXY.getWord.y);
    term("Guess the word ");
    term.moveTo(xOffset, termXY.getWord.y + 1);
    term("(RETURN to finish)");
    // move cursor to word input position
    term.moveTo(termXY.getWord.x, termXY.getWord.y);
    // erase what was there
    term("                                     ");
    // BUG is here - cursor moves to the wrong place
    term.moveTo(termXY.getWord.x, termXY.getWord.y);
    // term("Here " + termXY.getWord.x + "," + termXY.getWord.y);
    // term.moveTo(termXY.getWord.x, termXY.getWord.y + 5);
    // turn off the key event listener using global variable
    readWord = true;
    term.inputField({}, function (error, input) {
        if (error) {
            exitGame(term.red.str("\nAn error occurred reading input field: " + error + "\n"));
        }
        else {
            if (input === theWord.word2FullString()) {
                // guessed right
                readWord = false;
                wordCompleted();
            }
            else {
                // erase the instructions
                term.moveTo(xOffset, termXY.getWord.y);
                term("                                   ");
                term.moveTo(xOffset, termXY.getWord.y + 1);
                term("                    ");
                // BUG fix, erase the typing at the key input locations
                term.moveTo(termXY.input.x, termXY.input.y);
                term("                                ");
                // let user know what happened
                term.moveTo(termXY.getWord.x, termXY.getWord.y);
                term("Guess \"" + input + "\" was wrong                                  ");
                // move cursor back to input position
                term.moveTo(termXY.input.x, termXY.input.y);
                // let the event listener work again
                readWord = false;
            }
        }
    });
}
// function called when a key is pressed in raw mode
function processInput(char) {
    const regexp = new RegExp("[a-z]", "i");
    if (char === "ENTER") {
        // make a guess at the word
        guessWord();
        incGuess();
    }
    else if ((char.length === 1) && (regexp.test(char))) {
        const lcChar = char.toLowerCase();
        // check to see whether letter has already been selected
        if (_.indexOf(lettersChosen, lcChar) > -1) {
            // don't process anything because letter has already been selected
        }
        else {
            incGuess();
            theWord.checkChar(lcChar);
            lettersChosen.push(lcChar);
            // check to see if word is completed
            if (theWord.word2string().includes("_")) {
                // not completed
                showWord();
                showLettersChosen();
            }
            else {
                showWord();
                showLettersChosen();
                wordCompleted();
            }
        }
    }
    // any other key pressed does nothing  
}
function wordCompleted() {
    // erase guessed word
    term.moveTo(termXY.getWord.x, termXY.getWord.y);
    term("                                          ");
    term.moveTo(termXY.chooseAgain.x, termXY.chooseAgain.y);
    term("completed word \"" + theWord.word2FullString() + "\"");
    term(" Another game ? (Y/n)");
    readWord = true; // not really reading word but disables key event
    term.yesOrNo({ yes: ['y', 'Y', 'ENTER'], no: ['n', 'N'] }, function (error, result) {
        if (result) {
            readWord = false; // re-enabled key event
            start();
        }
        else {
            exitGame();
        }
    });
}
function start() {
    chooseWord();
    lettersChosen = [];
    guesses = -1; // referenced through incGuesses function which always increments so start at -1
    setupTerminal();
    showWord();
    showLettersChosen();
    incGuess(); // increments to 0 and displays number of guesses
    // after setup, program is driven by key presses
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// main program
start();
// set terminal up to read key presses
term.grabInput(true);
// set watcher on key input
term.on('key', function (name, matches, data) {
    if (name === 'CTRL_C') {
        exitGame("Control C pressed - exiting game");
    }
    else {
        // console.log("'key' event:" + name + " matches " + matches + " data " + data);
        if (!readWord) {
            processInput(name);
        }
    }
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUM7QUFFRCw4R0FBOEc7QUFDOUcsZUFBZTtBQUNmLEtBQUssRUFBRSxDQUFDO0FBRVIsc0NBQXNDO0FBQ3RDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7QUFFckIsMkJBQTJCO0FBQzNCLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLFVBQVUsSUFBVyxFQUFFLE9BQVcsRUFBRSxJQUFRO0lBQ3ZELElBQUksSUFBSSxLQUFLLFFBQVEsRUFBRTtRQUNuQixRQUFRLENBQUMsa0NBQWtDLENBQUMsQ0FBQztLQUNoRDtTQUNJO1FBQ0QsZ0ZBQWdGO1FBRWhGLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDWCxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDdEI7S0FDSjtBQUNMLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6IndvcmRHYW1lTm9kZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIG1haW4gcHJvZ3JhbSBmb3Igbm9kZSBiYXNlZCB3b3JkIGd1ZXNzaW5nIGdhbWVcclxuXHJcbmltcG9ydCAqIGFzIF8gZnJvbSBcImxvZGFzaFwiO1xyXG5pbXBvcnQgV29yZCBmcm9tIFwiLi93b3JkXCI7XHJcbmltcG9ydCB7dGVybWluYWwgYXMgdGVybX0gZnJvbSBcInRlcm1pbmFsLWtpdFwiO1xyXG5cclxuXHJcbi8vIGdsb2JhbCB2YXJpYWJsZXMgYW5kIGNvbnN0YW50c1xyXG5jb25zdCB3b3Jkc0FyciA9IFtcclxuICAgIFwiamF2YXNjcmlwdFwiLFxyXG4gICAgXCJodG1sXCIsXHJcbiAgICBcIm1vbmdvXCIsXHJcbiAgICBcImNocm9tZVwiLFxyXG4gICAgXCJub2RlXCIsXHJcbiAgICBcImNzc1wiXHJcbl07XHJcblxyXG4vLyBvZmZzZXRzIHRoZSBpbnN0cnVjdGlvbnMgZnJvbSBsZWZ0IGhhbmQgc2lkZVxyXG5jb25zdCB4T2Zmc2V0ID0gNTtcclxuLy8gb2JqZWN0IHRvIGhvbGQgeCx5IGxvY2F0aW9ucyBvZiBpbnB1dHMgYW5kIG91dHB1dHMgZm9yIHVzZSBieSB0ZXJtaW5hbC1raXRcclxuY29uc3QgdGVybVhZID0ge1xyXG4gICAgY2hvc2VuTGV0dGVyczogeyB4OjI1LCB5OjEyfSxcclxuICAgIHdvcmRTb0ZhcjogICAgIHsgeDoyNSwgeToxNn0sXHJcbiAgICBnZXRXb3JkOiAgICAgICB7IHg6MjUsIHk6MjB9LFxyXG4gICAgaW5wdXQ6ICAgICAgICAgeyB4OjI1LCB5OjE4fSxcclxuICAgIGNob29zZUFnYWluOiAgIHsgeDoyNSwgeToyM30sXHJcbiAgICBndWVzc2VzOiAgICAgICB7IHg6MjUsIHk6MTF9LFxyXG4gICAgdGl0bGU6ICAgICAgICAgeyB4OjMwLCB5OjJ9LFxyXG4gICAgaW5zdHJ1Y3Rpb25zOiAgeyB4OjUsICB5OjR9XHJcbn07XHJcblxyXG5cclxuLy8gY2FuJ3Qgc2VlbSB0byB0dXJuIG9mZiB0aGUgZXZlbnQgbGlzdGVuZXIgc28gdXNpbmcgYSBnbG9iYWwgdmFyaWFibGUgdG8gbWFrZSBpdCBkb2Vzbid0IHJldHVybiBhbnl0aGluZ1xyXG52YXIgcmVhZFdvcmQgPSBmYWxzZTtcclxuLy8gaG9sZHMgdGhlIHdvcmQgc2VsZWN0ZWQgYnkgcmFuZG9tIGZyb20gd29yZHNBcnJcclxudmFyIHRoZVdvcmQ6V29yZDtcclxuXHJcbi8vIGFycmF5IHRvIGhvbGQgdGhlIGxldHRlcnMgY2hvc2VuXHJcbnZhciBsZXR0ZXJzQ2hvc2VuOnN0cmluZ1tdID0gW107XHJcblxyXG4vLyBudW1iZXIgb2YgZ3Vlc3NlcyBhbmQgbWF4IGFsbG93ZWRcclxudmFyIGd1ZXNzZXM6bnVtYmVyID0gLTE7IC8vIHJlZmVyZW5jZWQgdGhyb3VnaCBpbmNHdWVzc2VzIGZ1bmN0aW9uIHdoaWNoIGFsd2F5cyBpbmNyZW1lbnRzIHNvIHN0YXJ0IGF0IC0xXHJcbmNvbnN0IG1heEd1ZXNzZXM6bnVtYmVyID0gMTA7XHJcblxyXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xyXG4vLyBmdW5jdGlvbnNcclxuXHJcbi8vIHJhbmRvbWx5IGNob29zZSBhIHdvcmQgZnJvbSB3b3Jkc0FyclxyXG5mdW5jdGlvbiBjaG9vc2VXb3JkICgpIHtcclxuICAgIGxldCByYW5kb20gPSBfLnJhbmRvbSgwLCAod29yZHNBcnIubGVuZ3RoIC0xICkpO1xyXG4gICAgdGhlV29yZCA9IG5ldyBXb3JkKHdvcmRzQXJyW3JhbmRvbV0pO1xyXG4gICAgXHJcbn1cclxuXHJcbi8vIGNsZWFycyB0aGUgc2NyZWVuIGFuZCB0aGVuIHByaW50cyBvdXQgaW5zdHJ1Y3Rpb25zIGFuZCBpbmZvcm1hdGlvblxyXG5mdW5jdGlvbiBzZXR1cFRlcm1pbmFsKCk6dm9pZCB7XHJcbiAgICB0ZXJtLmNsZWFyKCk7XHJcbiAgICAvLyB3cml0ZSBpbmZvcm1hdGlvbiB0byBzY3JlZW5cclxuICAgIC8vIHRpdGxlXHJcbiAgICB0ZXJtLm1vdmVUbyh0ZXJtWFkudGl0bGUueCwgdGVybVhZLnRpdGxlLnkpO1xyXG4gICAgdGVybS5ib2xkKFwiV29yZCBHYW1lXCIpO1xyXG4gICAgLy8gaW5zdHJ1Y3Rpb25zXHJcbiAgICB0ZXJtLm1vdmVUbyh0ZXJtWFkuaW5zdHJ1Y3Rpb25zLngsIHRlcm1YWS5pbnN0cnVjdGlvbnMueSk7XHJcbiAgICB0ZXJtKFwiSW5zdHJ1Y3Rpb25zOlxcblwiKTtcclxuICAgIHRlcm0oXCIgICAgICAgICBQcmVzcyBrZXlzIHRvIGd1ZXNzIGxldHRlcnMsIHlvdSBoYXZlIFwiICsgbWF4R3Vlc3NlcyArIFwiIGF0dGVtcHRzXFxuXCIpO1xyXG4gICAgdGVybShcIiAgICAgICAgIHByZXNzIFJFVFVSTiB0byBndWVzcyBhdCB0aGUgd29yZCAodGFrZXMgdXAgMSBhdHRlbXB0KVxcblwiKTtcclxuICAgIHRlcm0oXCIgICAgICAgICBwcmVzcyBjb250cm9sLUMgdG8gZW5kIHRoZSBnYW1lIGF0IGFueSB0aW1lXCIpO1xyXG4gICAgdGVybS5tb3ZlVG8oeE9mZnNldCx0ZXJtWFkuaW5wdXQueSk7XHJcbiAgICB0ZXJtKFwiVHlwZSBsZXR0ZXJzXCIpO1xyXG4gICAgdGVybS5tb3ZlVG8oeE9mZnNldCwgdGVybVhZLmNob3NlbkxldHRlcnMueSk7XHJcbiAgICB0ZXJtKFwiTGV0dGVycyBjaG9zZW4gXCIpO1xyXG4gICAgdGVybS5tb3ZlVG8oeE9mZnNldCwgdGVybVhZLndvcmRTb0Zhci55KTtcclxuICAgIHRlcm0oXCJXb3JkIHNvIGZhciBcIik7XHJcbiAgICAvLyBtb3ZlIGN1cnNvciB0byBpbnB1dCBwb3NpdGlvblxyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLmlucHV0LngsIHRlcm1YWS5pbnB1dC55KTtcclxuXHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBzaG93V29yZCgpOnZvaWQge1xyXG4gICAgbGV0IHdvcmQ6c3RyaW5nID0gdGhlV29yZC53b3JkMnN0cmluZygpO1xyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLndvcmRTb0Zhci54LCB0ZXJtWFkud29yZFNvRmFyLnkpO1xyXG4gICAgdGVybSh3b3JkKTtcclxuICAgIC8vIHdhbnQgdG8ga25vdyBob3cgbWFueSBjaGFyYWN0ZXJzXHJcbiAgICB0ZXJtKFwiICAoXCIgKyB0aGVXb3JkLmxldHRlckFyci5sZW5ndGggKyBcIiBjaGFyYWN0ZXJzKVwiKTtcclxuICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5pbnB1dC54LCB0ZXJtWFkuaW5wdXQueSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNob3dMZXR0ZXJzQ2hvc2VuICgpOnZvaWQge1xyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLmNob3NlbkxldHRlcnMueCwgdGVybVhZLmNob3NlbkxldHRlcnMueSk7XHJcbiAgICB0ZXJtKCBsZXR0ZXJzQ2hvc2VuLmpvaW4oXCIsXCIpKTtcclxuICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5pbnB1dC54LCB0ZXJtWFkuaW5wdXQueSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4aXRHYW1lKG1lc3NhZ2U/OiBhbnkpOiB2b2lkIHtcclxuICAgIC8vIG1vdmUgZG93biAxMCBsaW5lc1xyXG4gICAgdGVybS5uZXh0TGluZSgxMCk7XHJcbiAgICBpZiAobWVzc2FnZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coU3RyaW5nKG1lc3NhZ2UpKTtcclxuICAgIH1cclxuICAgIC8vIHVzaW5nIHRoaXMgZXhpdCByZXNldHMgYW55IHN0cmFuZ2Ugc3R1ZmYgdGhlIHRlcm1pbmFsIGlzIGRvaW5nXHJcbiAgICB0ZXJtLnByb2Nlc3NFeGl0KDApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpbmNHdWVzcygpOnZvaWQge1xyXG4gICAgZ3Vlc3NlcyArPSAxO1xyXG4gICAgaWYgKGd1ZXNzZXMgPiBtYXhHdWVzc2VzKSB7XHJcbiAgICAgICAgLy8gdG9vIG1hbnkgZ3Vlc3Nlc1xyXG4gICAgICAgIHRlcm0ubW92ZVRvKHRlcm1YWS5jaG9vc2VBZ2Fpbi54LCB0ZXJtWFkuY2hvb3NlQWdhaW4ueSk7XHJcbiAgICAgICAgdGVybShcIlRvbyBtYW55IGd1ZXNzZXMsIHlvdSBsb3NlLiBcIik7XHJcbiAgICAgICAgdGVybShcIiBBbm90aGVyIGdhbWUgPyAoWS9uKVwiKTtcclxuICAgICAgICByZWFkV29yZCA9IHRydWU7IC8vIG5vdCByZWFsbHkgcmVhZGluZyB3b3JkIGJ1dCBkaXNhYmxlcyBrZXkgZXZlbnRcclxuICAgICAgICB0ZXJtLnllc09yTm8oeyB5ZXM6IFsneScsICdZJywgJ0VOVEVSJ10sIG5vOiBbJ24nLCAnTiddIH0sIGZ1bmN0aW9uIChlcnJvciwgcmVzdWx0KSB7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgIHJlYWRXb3JkID0gZmFsc2U7IC8vIHJlLWVuYWJsZWQga2V5IGV2ZW50XHJcbiAgICAgICAgICAgICAgICBzdGFydCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZXhpdEdhbWUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgdGVybS5tb3ZlVG8odGVybVhZLmd1ZXNzZXMueCwgdGVybVhZLmd1ZXNzZXMueSk7XHJcbiAgICAgICAgdGVybShndWVzc2VzICsgXCIvXCIgKyBtYXhHdWVzc2VzICsgXCIgZ3Vlc3Nlc1wiKTtcclxuICAgICAgICAvLyBtb3ZlIGN1cnNvciBiYWNrIHRvIGlucHV0IHBvc2l0aW9uXHJcbiAgICAgICAgdGVybS5tb3ZlVG8odGVybVhZLmlucHV0LngsIHRlcm1YWS5pbnB1dC55KTtcclxuICAgICAgICBcclxuICAgIH1cclxufVxyXG5cclxuLy8gZnVuY3Rpb24gdG8gYWxsb3cgdXNlciB0byBtYWtlIGEgZ3Vlc3MgYXQgdGhlIHdob2xlIHdvcmRcclxuLy8gdGhpcyBzdGlsbCBoYXMgYSBCVUdcclxuZnVuY3Rpb24gZ3Vlc3NXb3JkKCk6dm9pZCB7XHJcbiAgICB0ZXJtLm1vdmVUbyh4T2Zmc2V0LCB0ZXJtWFkuZ2V0V29yZC55KTtcclxuICAgIHRlcm0oXCJHdWVzcyB0aGUgd29yZCBcIik7XHJcbiAgICB0ZXJtLm1vdmVUbyh4T2Zmc2V0LCB0ZXJtWFkuZ2V0V29yZC55ICsgMSk7XHJcbiAgICB0ZXJtKFwiKFJFVFVSTiB0byBmaW5pc2gpXCIpO1xyXG4gICAgLy8gbW92ZSBjdXJzb3IgdG8gd29yZCBpbnB1dCBwb3NpdGlvblxyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLmdldFdvcmQueCwgdGVybVhZLmdldFdvcmQueSk7XHJcbiAgICAvLyBlcmFzZSB3aGF0IHdhcyB0aGVyZVxyXG4gICAgdGVybShcIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIik7XHJcbiAgICAvLyBCVUcgaXMgaGVyZSAtIGN1cnNvciBtb3ZlcyB0byB0aGUgd3JvbmcgcGxhY2VcclxuICAgIGRlYnVnZ2VyO1xyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLmdldFdvcmQueCwgdGVybVhZLmdldFdvcmQueSk7XHJcbiAgICAvLyB0ZXJtKFwiSGVyZSBcIiArIHRlcm1YWS5nZXRXb3JkLnggKyBcIixcIiArIHRlcm1YWS5nZXRXb3JkLnkpO1xyXG4gICAgLy8gdGVybS5tb3ZlVG8odGVybVhZLmdldFdvcmQueCwgdGVybVhZLmdldFdvcmQueSArIDUpO1xyXG4gICAgLy8gdHVybiBvZmYgdGhlIGtleSBldmVudCBsaXN0ZW5lciB1c2luZyBnbG9iYWwgdmFyaWFibGVcclxuICAgIHJlYWRXb3JkID0gdHJ1ZTtcclxuICAgIHRlcm0uaW5wdXRGaWVsZCh7fSxmdW5jdGlvbiAoZXJyb3I6IGFueSwgaW5wdXQ6IHN0cmluZykge1xyXG4gICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICBleGl0R2FtZSh0ZXJtLnJlZC5zdHIoXCJcXG5BbiBlcnJvciBvY2N1cnJlZCByZWFkaW5nIGlucHV0IGZpZWxkOiBcIiArIGVycm9yICsgXCJcXG5cIikpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgaWYoIGlucHV0ID09PSB0aGVXb3JkLndvcmQyRnVsbFN0cmluZygpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBndWVzc2VkIHJpZ2h0XHJcbiAgICAgICAgICAgICAgICByZWFkV29yZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgd29yZENvbXBsZXRlZCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gZXJhc2UgdGhlIGluc3RydWN0aW9uc1xyXG4gICAgICAgICAgICAgICAgdGVybS5tb3ZlVG8oeE9mZnNldCwgdGVybVhZLmdldFdvcmQueSk7XHJcbiAgICAgICAgICAgICAgICB0ZXJtKFwiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIik7XHJcbiAgICAgICAgICAgICAgICB0ZXJtLm1vdmVUbyh4T2Zmc2V0LCB0ZXJtWFkuZ2V0V29yZC55ICsgMSk7XHJcbiAgICAgICAgICAgICAgICB0ZXJtKFwiICAgICAgICAgICAgICAgICAgICBcIik7XHJcbiAgICAgICAgICAgICAgICAvLyBCVUcgZml4LCBlcmFzZSB0aGUgdHlwaW5nIGF0IHRoZSBrZXkgaW5wdXQgbG9jYXRpb25zXHJcbiAgICAgICAgICAgICAgICB0ZXJtLm1vdmVUbyh0ZXJtWFkuaW5wdXQueCwgdGVybVhZLmlucHV0LnkpO1xyXG4gICAgICAgICAgICAgICAgdGVybShcIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCIpO1xyXG4gICAgICAgICAgICAgICAgLy8gbGV0IHVzZXIga25vdyB3aGF0IGhhcHBlbmVkXHJcbiAgICAgICAgICAgICAgICB0ZXJtLm1vdmVUbyh0ZXJtWFkuZ2V0V29yZC54LCB0ZXJtWFkuZ2V0V29yZC55KTtcclxuICAgICAgICAgICAgICAgIHRlcm0oXCJHdWVzcyBcXFwiXCIgKyBpbnB1dCArIFwiXFxcIiB3YXMgd3JvbmcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCIpO1xyXG4gICAgICAgICAgICAgICAgLy8gbW92ZSBjdXJzb3IgYmFjayB0byBpbnB1dCBwb3NpdGlvblxyXG4gICAgICAgICAgICAgICAgdGVybS5tb3ZlVG8odGVybVhZLmlucHV0LngsIHRlcm1YWS5pbnB1dC55KTtcclxuICAgICAgICAgICAgICAgIC8vIGxldCB0aGUgZXZlbnQgbGlzdGVuZXIgd29yayBhZ2FpblxyXG4gICAgICAgICAgICAgICAgcmVhZFdvcmQgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gICAgICBcclxuICAgIH0pO1xyXG59XHJcbi8vIGZ1bmN0aW9uIGNhbGxlZCB3aGVuIGEga2V5IGlzIHByZXNzZWQgaW4gcmF3IG1vZGVcclxuZnVuY3Rpb24gcHJvY2Vzc0lucHV0KCBjaGFyOnN0cmluZyk6dm9pZCB7XHJcbiAgICBjb25zdCByZWdleHAgPSBuZXcgUmVnRXhwKFwiW2Etel1cIiwgXCJpXCIpO1xyXG4gICAgaWYgKCBjaGFyID09PSBcIkVOVEVSXCIpIHtcclxuICAgICAgICAvLyBtYWtlIGEgZ3Vlc3MgYXQgdGhlIHdvcmRcclxuICAgICAgICBndWVzc1dvcmQoKTtcclxuICAgICAgICBpbmNHdWVzcygpO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoIChjaGFyLmxlbmd0aCA9PT0gMSkgJiYgKHJlZ2V4cC50ZXN0KGNoYXIpKSkge1xyXG4gICAgICAgIGNvbnN0IGxjQ2hhciA9IGNoYXIudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAvLyBjaGVjayB0byBzZWUgd2hldGhlciBsZXR0ZXIgaGFzIGFscmVhZHkgYmVlbiBzZWxlY3RlZFxyXG4gICAgICAgIGlmIChfLmluZGV4T2YobGV0dGVyc0Nob3NlbixsY0NoYXIpID4gLTEpIHtcclxuICAgICAgICAgICAgLy8gZG9uJ3QgcHJvY2VzcyBhbnl0aGluZyBiZWNhdXNlIGxldHRlciBoYXMgYWxyZWFkeSBiZWVuIHNlbGVjdGVkXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBpbmNHdWVzcygpO1xyXG4gICAgICAgICAgICB0aGVXb3JkLmNoZWNrQ2hhcihsY0NoYXIpO1xyXG4gICAgICAgICAgICBsZXR0ZXJzQ2hvc2VuLnB1c2gobGNDaGFyKTtcclxuICAgICAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHdvcmQgaXMgY29tcGxldGVkXHJcbiAgICAgICAgICAgIGlmICh0aGVXb3JkLndvcmQyc3RyaW5nKCkuaW5jbHVkZXMoXCJfXCIpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBub3QgY29tcGxldGVkXHJcbiAgICAgICAgICAgICAgICBzaG93V29yZCgpO1xyXG4gICAgICAgICAgICAgICAgc2hvd0xldHRlcnNDaG9zZW4oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNob3dXb3JkKCk7XHJcbiAgICAgICAgICAgICAgICBzaG93TGV0dGVyc0Nob3NlbigpO1xyXG4gICAgICAgICAgICAgICAgd29yZENvbXBsZXRlZCgpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gYW55IG90aGVyIGtleSBwcmVzc2VkIGRvZXMgbm90aGluZyAgXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHdvcmRDb21wbGV0ZWQoKTp2b2lkIHtcclxuICAgIC8vIGVyYXNlIGd1ZXNzZWQgd29yZFxyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLmdldFdvcmQueCwgdGVybVhZLmdldFdvcmQueSk7XHJcbiAgICB0ZXJtKFwiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCIpO1xyXG4gICAgdGVybS5tb3ZlVG8odGVybVhZLmNob29zZUFnYWluLngsIHRlcm1YWS5jaG9vc2VBZ2Fpbi55KTtcclxuICAgIHRlcm0oXCJjb21wbGV0ZWQgd29yZCBcXFwiXCIrIHRoZVdvcmQud29yZDJGdWxsU3RyaW5nKCkgKyBcIlxcXCJcIik7XHJcbiAgICB0ZXJtKFwiIEFub3RoZXIgZ2FtZSA/IChZL24pXCIpO1xyXG4gICAgcmVhZFdvcmQgPSB0cnVlOyAvLyBub3QgcmVhbGx5IHJlYWRpbmcgd29yZCBidXQgZGlzYWJsZXMga2V5IGV2ZW50XHJcbiAgICB0ZXJtLnllc09yTm8oeyB5ZXM6IFsneScsICdZJywnRU5URVInXSwgbm86IFsnbicsICdOJ10gfSwgZnVuY3Rpb24gKGVycm9yLCByZXN1bHQpIHtcclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgIHJlYWRXb3JkID0gZmFsc2U7IC8vIHJlLWVuYWJsZWQga2V5IGV2ZW50XHJcbiAgICAgICAgICAgIHN0YXJ0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBleGl0R2FtZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHN0YXJ0KCk6dm9pZCB7ICBcclxuICAgIGNob29zZVdvcmQoKTtcclxuICAgIGxldHRlcnNDaG9zZW4gPSBbXTtcclxuICAgIGd1ZXNzZXMgPSAtMTsgLy8gcmVmZXJlbmNlZCB0aHJvdWdoIGluY0d1ZXNzZXMgZnVuY3Rpb24gd2hpY2ggYWx3YXlzIGluY3JlbWVudHMgc28gc3RhcnQgYXQgLTFcclxuICAgIHNldHVwVGVybWluYWwoKTtcclxuICAgIHNob3dXb3JkKCk7XHJcbiAgICBzaG93TGV0dGVyc0Nob3NlbigpO1xyXG4gICAgaW5jR3Vlc3MoKTsgLy8gaW5jcmVtZW50cyB0byAwIGFuZCBkaXNwbGF5cyBudW1iZXIgb2YgZ3Vlc3Nlc1xyXG5cclxuICAgIC8vIGFmdGVyIHNldHVwLCBwcm9ncmFtIGlzIGRyaXZlbiBieSBrZXkgcHJlc3Nlc1xyXG59XHJcblxyXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xyXG4vLyBtYWluIHByb2dyYW1cclxuc3RhcnQoKTtcclxuXHJcbi8vIHNldCB0ZXJtaW5hbCB1cCB0byByZWFkIGtleSBwcmVzc2VzXHJcbnRlcm0uZ3JhYklucHV0KHRydWUpO1xyXG5cclxuLy8gc2V0IHdhdGNoZXIgb24ga2V5IGlucHV0XHJcbnRlcm0ub24oJ2tleScsIGZ1bmN0aW9uIChuYW1lOnN0cmluZywgbWF0Y2hlczphbnksIGRhdGE6YW55KSB7XHJcbiAgICBpZiAobmFtZSA9PT0gJ0NUUkxfQycpIHtcclxuICAgICAgICBleGl0R2FtZShcIkNvbnRyb2wgQyBwcmVzc2VkIC0gZXhpdGluZyBnYW1lXCIpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCIna2V5JyBldmVudDpcIiArIG5hbWUgKyBcIiBtYXRjaGVzIFwiICsgbWF0Y2hlcyArIFwiIGRhdGEgXCIgKyBkYXRhKTtcclxuICAgICAgICBcclxuICAgICAgICBpZiAoIXJlYWRXb3JkKSB7XHJcbiAgICAgICAgICAgIHByb2Nlc3NJbnB1dChuYW1lKTtcclxuICAgICAgICB9IFxyXG4gICAgfVxyXG59KTtcclxuXHJcblxyXG5cclxuIl19
